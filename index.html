<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KTU Tools - ECE 2019</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; color:#333; }
  header { background:#004080; color:white; text-align:center; padding:15px; }
  .container { max-width:900px; margin:20px auto; padding:20px; background:white; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
  h2 { color:#004080; }
  .btn { margin:10px 5px; padding:10px 20px; font-size:16px; background:#004080; color:white; border:none; border-radius:6px; cursor:pointer; }
  .btn:hover { background:#003060; }
  .btn:disabled { background:#ccc; cursor:not-allowed; }
  .input-group { margin:10px 0; }
  select, input { width:100%; padding:10px; font-size:16px; border:1px solid #ccc; border-radius:6px; }
  .subject-row { display:flex; gap:10px; margin-bottom:5px; }
  .subject-row span { flex:2; align-self:center; }
  .subject-row select { flex:1; }
  .result { margin-top:10px; padding:10px; background:#f0f8ff; border-left:4px solid #004080; white-space:pre-line; }
  .error { color:red; font-weight:bold; margin-top:10px; }
  @media (max-width:600px){
    .subject-row { flex-direction:column; }
    .subject-row span, .subject-row select { width:100%; }
  }
</style>
</head>
<body>

<header>
  <h1>KTU Tools</h1>
</header>

<div class="container" id="homeScreen">
  <h2>Select a Calculator</h2>
  <button class="btn" onclick="showCGPA()">CGPA Calculator</button>
  <button class="btn" onclick="showAttendance()">Attendance Calculator</button>
</div>

<div class="container" id="cgpaScreen" style="display:none;">
  <h2>CGPA Calculator</h2>
  <div class="input-group">
    <label>Department</label>
    <select id="department">
      <option value="">-- Select Department --</option>
      <option value="ECE">ECE</option>
      <option value="EEE">EEE (Coming Soon)</option>
      <option value="CSE">CSE (Coming Soon)</option>
    </select>
  </div>
  <div class="input-group">
    <label>Scheme</label>
    <select id="scheme">
      <option value="">-- Select Scheme --</option>
      <option value="2019">2019</option>
      <option value="2015">2015 (Coming Soon)</option>
    </select>
  </div>
  <button class="btn" onclick="loadSemesters()">Load</button>
  <div id="semesters"></div>
  <div id="cgpaControls" style="display:none;">
    <button class="btn" id="calcBtn" onclick="calcCGPA()">Calculate Overall CGPA</button>
    <button class="btn" id="shareBtn" onclick="shareResult()">Share Result</button>
    <div class="result" id="cgpaResult"></div>
    <div id="shareMsg" style="margin-top:5px;color:green;font-weight:bold;"></div>
  </div>
  <div id="errorMsg" class="error"></div>
  <button class="btn" onclick="goHome()">Back</button>
</div>

<div class="container" id="attendanceScreen" style="display:none;">
  <h2>Attendance Calculator</h2>
  <div class="input-group">
    <label>Classes Attended</label>
    <input type="number" id="attended" placeholder="Enter attended classes">
  </div>
  <div class="input-group">
    <label>Total Classes</label>
    <input type="number" id="total" placeholder="Enter total classes">
  </div>
  <div class="input-group">
    <label>Target %</label>
    <select id="target">
      <option value="75">75%</option>
      <option value="80">80%</option>
      <option value="85">85%</option>
      <option value="90">90%</option>
      <option value="95">95%</option>
    </select>
  </div>
  <button class="btn" onclick="calcAttendance()">Calculate</button>
  <div class="result" id="attendanceResult"></div>
  <button class="btn" onclick="goHome()">Back</button>
</div>

<script>
// ===== Correct KTU 2019 Grading Map =====
const gradeMap = { 
  'S':10, 'A+':9.0, 'A':8.5, 
  'B+':8.0, 'B':7.5, 'C+':7.0, 
  'C':6.5, 'D':6.0, 'P':5.5, 
  'F':0.0, 'FE':0.0, 'I':0.0 
};

let syllabusData = {};
let currentResults = {};

// ===== Navigation Functions =====
function showCGPA(){
  document.getElementById('homeScreen').style.display='none';
  document.getElementById('cgpaScreen').style.display='block';
}
function showAttendance(){
  document.getElementById('homeScreen').style.display='none';
  document.getElementById('attendanceScreen').style.display='block';
}
function goHome(){
  document.getElementById('cgpaScreen').style.display='none';
  document.getElementById('attendanceScreen').style.display='none';
  document.getElementById('homeScreen').style.display='block';
}

// ===== NEW: LocalStorage Functions =====
function saveGrade(selectElement) {
  localStorage.setItem('grade_' + selectElement.id, selectElement.value);
}

function loadGrades() {
  Object.keys(syllabusData).forEach(sem => {
    syllabusData[sem].forEach((sub, i) => {
      const gradeId = `${sem}_${i}`;
      const savedGrade = localStorage.getItem('grade_' + gradeId);
      if (savedGrade) {
        document.getElementById(gradeId).value = savedGrade;
      }
    });
  });
}

function clearGrades() {
  if (confirm("Are you sure you want to clear all saved grades? This cannot be undone.")) {
    Object.keys(syllabusData).forEach(sem => {
      syllabusData[sem].forEach((sub, i) => {
        const gradeId = `${sem}_${i}`;
        localStorage.removeItem('grade_' + gradeId);
      });
    });
    renderSemesters(); // Re-render to show cleared dropdowns
    document.getElementById('cgpaResult').innerText = "";
    Object.keys(currentResults).forEach(key => delete currentResults[key]);
    alert("All saved grades have been cleared.");
  }
}

// ===== CGPA Calculator Functions =====
function loadSemesters(){
  const dept = document.getElementById('department').value;
  const scheme = document.getElementById('scheme').value;
  if(dept==='ECE' && scheme==='2019'){
    fetch('ece2019.json')
    .then(res=>{
      if(!res.ok) throw new Error("File not found");
      return res.json();
    })
    .then(data=>{
      syllabusData = data;
      renderSemesters();
      loadGrades(); // MODIFIED: Load grades after rendering
      document.getElementById('cgpaControls').style.display='block';
      document.getElementById('errorMsg').innerText='';
    })
    .catch(err=>{
      document.getElementById('errorMsg').innerText="❌ Could not load syllabus data. Check file path or name.";
    });
  } else {
    alert("Only ECE 2019 is available now.");
  }
}

function renderSemesters(){
  let container=document.getElementById('semesters');
  container.innerHTML='';
  currentResults={};
  Object.keys(syllabusData).forEach(sem=>{
    let div=document.createElement('div');
    div.innerHTML=`<h3>${sem}</h3>`;
    syllabusData[sem].forEach((sub,i)=>{
      let row=document.createElement('div');
      row.className='subject-row';
      row.innerHTML=`
        <span>${sub.code} – ${sub.name} (${sub.credit}cr)</span>
        <select id="${sem}_${i}" onchange="saveGrade(this)"> <option value="">Grade</option>
          ${Object.keys(gradeMap).map(g=>`<option>${g}</option>`).join('')}
        </select>`;
      div.appendChild(row);
    });
    div.innerHTML+=`<button class="btn" onclick="calcSGPA('${sem}')">Calculate SGPA</button>
                    <div class="result" id="${sem}_sgpa">SGPA: -</div>`;
    container.appendChild(div);
  });
}

function calcSGPA(sem){
  let subjects=syllabusData[sem];
  let points=0, credits=0;
  subjects.forEach((sub,i)=>{
    let grade=document.getElementById(`${sem}_${i}`).value;
    if(grade && sub.credit>0){
      points+=gradeMap[grade]*sub.credit;
      credits+=sub.credit;
    }
  });
  if(credits>0){
    let sgpa=(points/credits).toFixed(2);
    document.getElementById(`${sem}_sgpa`).innerText=`SGPA: ${sgpa}`;
    currentResults[sem]=sgpa;
  } else {
    document.getElementById(`${sem}_sgpa`).innerText="SGPA: -";
    delete currentResults[sem];
  }
}

function calcCGPA(){
  let totalPoints=0, totalCredits=0;
  Object.keys(syllabusData).forEach(sem=>{
    let subjects=syllabusData[sem];
    subjects.forEach((sub,i)=>{
      let grade=document.getElementById(`${sem}_${i}`)?.value;
      if(grade && sub.credit>0){
        totalPoints+=gradeMap[grade]*sub.credit;
        totalCredits+=sub.credit;
      }
    });
  });
  if(totalCredits>0){
    let cgpa=(totalPoints/totalCredits).toFixed(2);
    document.getElementById('cgpaResult').innerText=`Overall CGPA: ${cgpa}`;
    currentResults['CGPA']=cgpa;
  } else {
    document.getElementById('cgpaResult').innerText="Fill in grades to calculate CGPA";
  }
}

function shareResult(){
  let text='';
  Object.keys(currentResults).forEach(key=>{
    if(key!=='CGPA'){ text+=`${key} SGPA: ${currentResults[key]}\n`; }
  });
  if(currentResults['CGPA']) text+=`Overall CGPA: ${currentResults['CGPA']}`;
  if(text===''){ alert("Please calculate SGPA or CGPA first."); return; }
  navigator.clipboard.writeText(text).then(()=>{
    document.getElementById('shareMsg').innerText="Result copied to clipboard. You can paste and share it.";
  });
}

// ===== Attendance Calculator Function =====
function calcAttendance(){
  let attended=parseInt(document.getElementById('attended').value);
  let total=parseInt(document.getElementById('total').value);
  let target=parseInt(document.getElementById('target').value);
  if(isNaN(attended)||isNaN(total)||total<=0){ alert("Enter valid numbers"); return; }

  let percent=(attended/total*100).toFixed(2);
  let result=`Current Attendance: ${percent}%\n`;

  if(percent >= target){
    let maxBunk = Math.floor((attended*100/target) - total);
    if(maxBunk < 0) maxBunk = 0;
    result+=`✅ You are safe. You can miss ${maxBunk} more classes.`;
  } else {
    let need = Math.ceil((target*total - 100*attended) / (100 - target));
    if(need < 0) need = 0;
    result+=`⚠️ You must attend the next ${need} classes to reach ${target}%.`;
  }

  document.getElementById('attendanceResult').innerText=result;
}
</script>

</body>
</html>

